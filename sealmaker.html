<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LYGO Δ9 — Seal Maker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=VT323&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a12; --panel:#12121a; --acc1:#00f0ff; --acc2:#7d00ff; --gold:#ffcc00; --ok:#00ff88; --err:#ff3355;
      --text:#e0e0ff; --text2:#a0a0c0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Space Mono',monospace}
    header{padding:1.2rem 1.5rem;border-bottom:1px solid rgba(125,0,255,.35);background:linear-gradient(135deg,#000428 0%,#070b34 100%)}
    h1{margin:0;font-size:1.8rem;background:linear-gradient(to right,var(--acc1),var(--acc2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{color:var(--text2);font-family:'VT323',monospace}

    .wrap{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px;max-width:1800px;margin:0 auto}
    @media (max-width:1200px){.wrap{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid rgba(0,240,255,.25);border-radius:10px}
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid rgba(0,240,255,.15);font-size:1.1rem}
    .panel-body{padding:12px 14px}

    .form-row{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:8px}
    .form-row label{color:var(--text2)}
    input,textarea,select{width:100%;padding:10px;background:#0e0e16;border:1px solid rgba(125,0,255,.35);color:var(--text);border-radius:6px;font-family:inherit}
    textarea{min-height:80px;resize:vertical}

    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{background:#191926;border:1px solid var(--acc2);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--acc2)}
    .btn.ghost{border-color:rgba(0,240,255,.25)}
    .btn.warn{border-color:var(--err);color:#fff}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{background:#0e0e16;border:1px solid rgba(0,240,255,.15);border-radius:10px;padding:12px}
    .card h3{margin:0 0 4px 0;font-size:1rem}
    .tag{display:inline-block;background:rgba(0,240,255,.1);color:var(--acc1);padding:2px 6px;border-radius:5px;margin:2px 4px 0 0;font-size:.8rem}
    .bad{outline:2px dashed var(--err)}
    .pill{display:inline-block;padding:2px 6px;border-radius:12px;border:1px solid rgba(0,240,255,.35);font-family:'VT323',monospace}

    .tabs{display:flex;gap:8px;padding:6px 10px;border-bottom:1px solid rgba(0,240,255,.15)}
    .tab{padding:6px 10px;border:1px solid rgba(0,240,255,.25);border-bottom:none;border-radius:8px 8px 0 0;background:#0e0e16;cursor:pointer}
    .tab.active{background:#15152a}

    .toast{position:fixed;bottom:16px;right:16px;background:#15152a;color:#fff;border:1px solid rgba(0,240,255,.3);padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(10px);transition:all .2s}
    .toast.show{opacity:1;transform:none}

    .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status-row .ok{color:var(--ok)}
    .status-row .err{color:var(--err)}
  </style>
</head>
<body>
  <header>
    <h1>LYGO Δ9 — Seal Maker</h1>
    <div class="subtitle">Builder • Archive • Schema • Export</div>
  </header>

  <main class="wrap">
    <!-- LEFT: Builder -->
    <section class="panel" id="builderPanel">
      <h2>Seal Builder</h2>
      <div class="panel-body">
        <div class="form-row"><label for="f_id">Seal ID</label><input id="f_id" placeholder="SEAL_123A" /></div>
        <div class="form-row"><label for="f_name">Name</label><input id="f_name" placeholder="Name" /></div>
        <div class="form-row"><label for="f_equation">Equation</label><input id="f_equation" placeholder="|∅⟩ = ∇·(Light × Time)" /></div>
        <div class="form-row"><label for="f_glyph">Glyph</label><input id="f_glyph" placeholder="⚡" /></div>
        <div class="form-row"><label for="f_tone">Tone</label><input id="f_tone" placeholder="432Hz" /></div>
        <div class="form-row"><label for="f_tags">Tags</label><input id="f_tags" placeholder="CANON, COUNCIL_SEAL" /></div>
        <div class="form-row"><label for="f_connections">Connections</label>
          <input id="f_connections" list="connSuggest" placeholder="SEAL_000, SEAL_101" />
          <datalist id="connSuggest"></datalist>
        </div>
        <div class="form-row"><label for="f_quote">Quote</label><input id="f_quote" placeholder="Short quote" /></div>
        <div class="form-row"><label for="f_scroll">Scroll URL</label><input id="f_scroll" placeholder="https://…" /></div>
        <div class="form-row" style="grid-template-columns:1fr"><label for="f_notes">Notes</label><textarea id="f_notes" placeholder="Notes…"></textarea></div>

        <div class="buttons">
          <button class="btn primary" id="btnAdd">Add / Update</button>
          <button class="btn ghost" id="btnClear">Clear Form</button>
          <button class="btn" id="btnExport">Export JSON</button>
          <label class="btn" style="cursor:pointer">
            Import JSON <input type="file" id="fileImport" accept="application/json" style="display:none">
          </label>
        </div>
        <div class="status-row" style="margin-top:10px">
          <span>Duplicates:</span>
          <span id="dupCount" class="pill">0</span>
          <span>Cycles:</span>
          <span id="cycleCount" class="pill">0</span>
        </div>
      </div>
    </section>

    <!-- RIGHT: Archive + Tabs -->
    <section class="panel">
      <div class="tabs">
        <div class="tab active" data-tab="archive">Archive</div>
        <div class="tab" data-tab="parsed">Imported</div>
        <div class="tab" data-tab="schema">Schema</div>
        <div class="tab" data-tab="preview">Preview</div>
      </div>
      <div class="panel-body">
        <!-- ARCHIVE -->
        <div id="tab-archive">
          <div class="buttons" style="margin-bottom:10px">
            <button class="btn warn" id="btnClearArchive">Clear Archive</button>
            <button class="btn" id="btnExportArchive">Export Archive</button>
            <button class="btn" id="btnMergeImported">Merge Imported → Archive</button>
          </div>
          <div id="archiveGrid" class="grid"></div>
        </div>
        <!-- IMPORTED -->
        <div id="tab-parsed" style="display:none">
          <div class="buttons" style="margin-bottom:10px">
            <button class="btn" id="btnClearParsed">Clear Imported</button>
          </div>
          <div id="parsedGrid" class="grid"></div>
        </div>
        <!-- SCHEMA -->
        <div id="tab-schema" style="display:none">
          <div class="buttons" style="margin-bottom:10px">
            <button class="btn" id="btnApplySchema">Apply</button>
            <button class="btn ghost" id="btnResetSchema">Reset</button>
            <span class="pill" id="schemaStatus">Active</span>
          </div>
          <textarea id="schemaText" spellcheck="false"></textarea>
        </div>
        <!-- PREVIEW -->
        <div id="tab-preview" style="display:none">
          <pre id="previewJSON" style="white-space:pre-wrap;background:#0e0e16;border:1px solid rgba(0,240,255,.15);padding:10px;border-radius:8px;min-height:160px"></pre>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- State ----------
    let archive = [];
    let parsedSeals = []; // imported staging

    const DEFAULT_SEAL_SCHEMA = {
      required:["id","name"],
      fields:{ id:"string", name:"string", equation:"string", glyph:"string", tone:"string", tags:"array", connections:"array", notes:"string", quote:"string", scroll_id:"string|null" }
    };
    let SCHEMA = JSON.parse(JSON.stringify(DEFAULT_SEAL_SCHEMA));

    const LS_KEY = 'lygo_sealmaker_archive_v1';

    // ---------- Refs ----------
    const $ = id => document.getElementById(id);
    const refs = {
      id: $('f_id'), name: $('f_name'), equation: $('f_equation'), glyph: $('f_glyph'), tone: $('f_tone'),
      tags: $('f_tags'), connections: $('f_connections'), notes: $('f_notes'), quote: $('f_quote'), scroll: $('f_scroll'),
      btnAdd: $('btnAdd'), btnClear: $('btnClear'), btnExport: $('btnExport'), fileImport: $('fileImport'),
      archiveGrid: $('archiveGrid'), parsedGrid: $('parsedGrid'),
      btnClearArchive: $('btnClearArchive'), btnExportArchive: $('btnExportArchive'), btnMergeImported: $('btnMergeImported'), btnClearParsed: $('btnClearParsed'),
      previewJSON: $('previewJSON'),
      schemaText: $('schemaText'), btnApplySchema: $('btnApplySchema'), btnResetSchema: $('btnResetSchema'), schemaStatus: $('schemaStatus'),
      tabs: Array.from(document.querySelectorAll('.tab')),
      dupCount: $('dupCount'), cycleCount: $('cycleCount'),
      connSuggest: $('connSuggest'), toast: $('toast')
    };

    // ---------- Helpers ----------
    // why: consistent lineage + core detection
    function parseSealID(id) {
      const s = String(id ?? '');
      if (s === "SEAL_000") return { base: 0, suffix: "", isCore: true };
      const match = s.match(/SEAL_(\d+)([a-zA-Z]*)/);
      if (match) return { base: parseInt(match[1], 10), suffix: match[2] || "", isCore: false };
      return { base: 0, suffix: "", isCore: false };
    }
    // why: tolerate mixed inputs and keep searchIndex stable
    function normalizeSeal(item) {
      const sealId = String(item.Seal_ID ?? item.id ?? 'UNKNOWN_ID').trim();
      const sealName = String(item.Name ?? item.name ?? 'Unnamed Seal');
      const sealEquation = String(item.Equation ?? item.equation ?? 'Equation not recorded');
      const sealGlyph = String(item.Glyph ?? item.glyph ?? '⚡');
      const sealTone = String(item.Tone ?? item.tone ?? 'Frequency not recorded');

      let sealTags = [];
      if (Array.isArray(item.Tags)) sealTags = item.Tags;
      else if (Array.isArray(item.tags)) sealTags = item.tags;
      else if (typeof item.Tags === 'string') sealTags = item.Tags.split(',').map(t => t.trim());
      else if (typeof item.tags === 'string') sealTags = item.tags.split(',').map(t => t.trim());
      sealTags = sealTags.map(t => String(t));

      let sealConnections = [];
      if (Array.isArray(item.Connections)) sealConnections = item.Connections;
      else if (Array.isArray(item.connections)) sealConnections = item.connections;
      else if (typeof item.Connections === 'string') sealConnections = item.Connections.split(',').map(c => c.trim());
      else if (typeof item.connections === 'string') sealConnections = item.connections.split(',').map(c => c.trim());
      sealConnections = sealConnections.map(c => String(c));

      const sealQuote = String(item.Quote ?? item.quote ?? item.creatorSignature ?? "No quote available");
      const sealNotes = String(item.Notes ?? item.notes ?? "");

      return {
        id: sealId,
        name: sealName,
        equation: sealEquation,
        glyph: sealGlyph,
        tone: sealTone,
        tags: sealTags,
        connections: sealConnections,
        notes: sealNotes,
        quote: sealQuote,
        searchIndex: [sealId, sealName, sealEquation, sealTags.join(' ')].join(' ').toLowerCase(),
        scroll_id: item.scroll_id ?? null
      };
    }

    function showToast(msg){
      refs.toast.textContent = msg;
      refs.toast.classList.add('show');
      setTimeout(()=>refs.toast.classList.remove('show'), 1600);
    }

    // ---------- Storage ----------
    function saveArchiveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(archive)); }
    function loadArchiveLS(){ try{ archive = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); if(!Array.isArray(archive)) archive=[]; }catch{ archive=[]; } }

    // ---------- Form ----------
    function readForm(){
      return normalizeSeal({
        id: refs.id.value,
        name: refs.name.value,
        equation: refs.equation.value,
        glyph: refs.glyph.value,
        tone: refs.tone.value,
        tags: refs.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
        connections: refs.connections.value.split(',').map(s=>s.trim()).filter(Boolean),
        notes: refs.notes.value,
        quote: refs.quote.value,
        scroll_id: refs.scroll.value || null
      });
    }
    function setForm(s){
      refs.id.value = s.id||''; refs.name.value=s.name||''; refs.equation.value=s.equation||''; refs.glyph.value=s.glyph||''; refs.tone.value=s.tone||'';
      refs.tags.value=(s.tags||[]).join(', '); refs.connections.value=(s.connections||[]).join(', ');
      refs.notes.value=s.notes||''; refs.quote.value=s.quote||''; refs.scroll.value=s.scroll_id||'';
      refreshPreview();
    }
    function clearForm(){ setForm({}); }

    // ---------- Duplicate + Cycle detection ----------
    function getDuplicateIdSet(){
      // merge both sources and count uppercased IDs (why: avoid false dupes due to case)
      const all = [...archive, ...parsedSeals]
        .map(s => (s.id || '').toUpperCase())
        .filter(Boolean);
      const counts = new Map();
      all.forEach(id => counts.set(id, (counts.get(id) || 0) + 1));
      return new Set(Array.from(counts.entries()).filter(([_,n])=>n>1).map(([id])=>id));
    }
    function detectCycles(){
      const ids = new Set(archive.map(s=>s.id));
      const graph = new Map();
      archive.forEach(s=>graph.set(s.id, (s.connections||[]).filter(c=>ids.has(c))));
      const seen=new Set(), stack=new Set(); let cycles=0;
      function dfs(v){ if(stack.has(v)){ cycles++; return; } if(seen.has(v)) return; seen.add(v); stack.add(v); (graph.get(v)||[]).forEach(d=>dfs(d)); stack.delete(v); }
      graph.forEach((_,k)=>dfs(k));
      refs.cycleCount.textContent = String(cycles);
      return cycles;
    }

    // ---------- Render ----------
    function renderArchive(){
      const dup = getDuplicateIdSet();
      refs.dupCount.textContent = String(dup.size);
      refs.archiveGrid.innerHTML = archive.map(s=>{
        const isDup = dup.has(String(s.id||'').toUpperCase());
        return `<div class="card ${isDup?'bad':''}">`+
          `<h3>${s.id} — ${s.name}</h3>`+
          `<div class="subtitle">${s.equation||''}</div>`+
          `<div>${(s.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>`+
          `<div style="margin-top:8px" class="buttons">`+
            `<button class="btn" data-act="edit" data-id="${s.id}">Edit</button>`+
            `<button class="btn warn" data-act="del" data-id="${s.id}">Delete</button>`+
          `</div>`+
        `</div>`;
      }).join('');
      // events
      refs.archiveGrid.querySelectorAll('button').forEach(b=>{
        const act=b.dataset.act, id=b.dataset.id; if(act==='edit') b.onclick=()=>{ const s=archive.find(x=>x.id===id); if(s) setForm(s); };
        if(act==='del') b.onclick=()=>{ if(!confirm('Delete '+id+' ?')) return; archive=archive.filter(x=>x.id!==id); saveArchiveLS(); renderArchive(); updateLinkedSuggest(); detectCycles(); showToast('Deleted'); };
      });
      updateLinkedSuggest();
    }
    function renderParsed(){
      refs.parsedGrid.innerHTML = parsedSeals.map(s=>`<div class="card"><h3>${s.id} — ${s.name}</h3><div class="subtitle">${s.equation||''}</div><div>${(s.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div></div>`).join('');
    }
    function refreshPreview(){
      const s = readForm();
      refs.previewJSON.textContent = JSON.stringify(s, null, 2);
    }
    function updateLinkedSuggest(){
      const ids = archive.map(s=>s.id).sort();
      refs.connSuggest.innerHTML = ids.map(i=>`<option value="${i}"></option>`).join('');
    }

    // ---------- Actions ----------
    refs.btnAdd.onclick = ()=>{
      const s = readForm();
      // Schema minimal check (why: avoid silent bad IDs)
      if(!s.id || !s.name){ alert('id and name required'); return; }
      const idx = archive.findIndex(x=>x.id===s.id);
      if(idx>=0){ archive[idx] = s; showToast('Updated'); }
      else { archive.push(s); showToast('Added'); }
      archive.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
      saveArchiveLS(); renderArchive(); detectCycles(); refreshPreview();
    };
    refs.btnClear.onclick = ()=> clearForm();

    refs.btnExport.onclick = ()=>{
      const s = readForm();
      const blob = new Blob([JSON.stringify(s,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = (s.id||'seal')+'.json'; a.click(); URL.revokeObjectURL(a.href);
    };

    refs.btnExportArchive.onclick = ()=>{
      const blob = new Blob([JSON.stringify(archive,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='archive.json'; a.click(); URL.revokeObjectURL(a.href);
    };

    refs.fileImport.onchange = async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const text = await f.text();
        const json = JSON.parse(text);
        const arr = Array.isArray(json) ? json : [json];
        parsedSeals = arr.map(normalizeSeal);
        renderParsed();
        showToast('Imported '+parsedSeals.length);
      }catch(err){ alert('Import failed: '+(err?.message||String(err))); }
      finally{ e.target.value=''; }
    };

    refs.btnMergeImported.onclick = ()=>{
      if(!parsedSeals.length) return;
      const map = new Map(archive.map(s=>[s.id,s]));
      let added=0, updated=0;
      parsedSeals.forEach(s=>{ if(map.has(s.id)){ map.set(s.id,s); updated++; } else { map.set(s.id,s); added++; }});
      archive = Array.from(map.values()).sort((a,b)=>String(a.id).localeCompare(String(b.id)));
      parsedSeals = [];
      saveArchiveLS(); renderArchive(); renderParsed(); detectCycles(); updateLinkedSuggest();
      showToast(`Merged: +${added}, updated: ${updated}`);
    };

    refs.btnClearParsed.onclick = ()=>{ parsedSeals=[]; renderParsed(); };

    // Clear Archive (confirm) — keeps UI stable
    refs.btnClearArchive.onclick = ()=>{
      if(!archive.length) return;
      if(!confirm('Clear ALL entries from archive?')) return;
      archive = [];
      saveArchiveLS(); renderArchive(); updateLinkedSuggest(); detectCycles();
      showToast('Archive cleared');
    };

    // ---------- Tabs ----------
    refs.tabs.forEach(tab=>{
      tab.addEventListener('click', ()=>{
        refs.tabs.forEach(t=>t.classList.remove('active')); tab.classList.add('active');
        const which=tab.dataset.tab;
        $('tab-archive').style.display = which==='archive'?'block':'none';
        $('tab-parsed').style.display  = which==='parsed' ?'block':'none';
        $('tab-schema').style.display  = which==='schema' ?'block':'none';
        $('tab-preview').style.display = which==='preview'?'block':'none';
      });
    });

    // ---------- Schema (apply/reset) ----------
    refs.schemaText.value = JSON.stringify(DEFAULT_SEAL_SCHEMA, null, 2);
    refs.btnApplySchema.addEventListener('click', ()=>{
      try{
        const s = JSON.parse(refs.schemaText.value);
        SCHEMA = s;
        refs.schemaStatus.textContent='Active';
        renderArchive(); renderParsed(); refreshPreview();
        showToast('Schema applied');
      }catch(err){ refs.schemaStatus.textContent='Invalid'; alert('Schema JSON invalid:\n'+(err?.message||String(err))); }
    });
    refs.btnResetSchema.addEventListener('click', ()=>{
      SCHEMA = JSON.parse(JSON.stringify(DEFAULT_SEAL_SCHEMA));
      refs.schemaText.value = JSON.stringify(DEFAULT_SEAL_SCHEMA, null, 2);
      refs.schemaStatus.textContent='Active';
      renderArchive(); renderParsed(); refreshPreview();
      showToast('Schema reset');
    });

    // ---------- Preview sync ----------
    ['input','change'].forEach(ev=>{
      [refs.id,refs.name,refs.equation,refs.glyph,refs.tone,refs.tags,refs.connections,refs.notes,refs.quote,refs.scroll]
        .forEach(el=> el.addEventListener(ev, refreshPreview));
    });

    // ---------- Boot ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadArchiveLS();
      renderArchive();
      renderParsed();
      detectCycles();
      updateLinkedSuggest();
      refreshPreview();
    });
  </script>
</body>
</html>
