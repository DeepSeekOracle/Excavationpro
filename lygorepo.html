<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LYGO Œî9 StarNexus | Canonical V7</title>
  <meta name="theme-color" content="#0a0a12" />
  <meta name="description" content="Quantum Seal Nexus - Archive & Star Chart UI" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=VT323&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --quantum-blue: #00f0ff;
      --void-purple: #7d00ff;
      --starforge-gold: #ffcc00;
      --background-dark: #0a0a12;
      --panel-dark: #12121a;
      --text-primary: #e0e0ff;
      --text-secondary: #a0a0c0;
      --font-main: 'Space Mono', monospace;
      --font-glyph: 'VT323', monospace;
      --geometric-border: 1px solid rgba(0, 240, 255, 0.3);
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background-color: var(--background-dark);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    header {
      background: linear-gradient(135deg, #000428 0%, #070b34 100%);
      padding: 1.5rem;
      border-bottom: 1px solid var(--void-purple);
    }

    header h1 {
      font-size: 2.5rem;
      background: linear-gradient(to right, var(--quantum-blue), var(--void-purple));
      -webkit-background-clip: text;
      color: transparent;
      margin: 0;
      text-shadow: 0 0 10px rgba(0, 240, 255, 0.4);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 2rem;
    }

    .controls input,
    .controls select,
    .controls button {
      padding: 0.5rem;
      font-family: var(--font-main);
      background-color: var(--panel-dark);
      border: var(--geometric-border);
      color: var(--text-primary);
    }

    .controls button:hover {
      background-color: var(--quantum-blue);
      color: black;
      cursor: pointer;
    }

    #starmap {
      width: 100%;
      height: 80vh;
      background-color: rgba(0, 0, 0, 0.2);
      border: var(--geometric-border);
      margin: 2rem 0;
    }

    #sealDetails {
      padding: 2rem;
      background-color: var(--panel-dark);
      border-top: 1px dashed var(--quantum-blue);
    }

    .seal-preview-json {
      background: rgba(0, 0, 0, 0.5);
      padding: 1rem;
      font-family: monospace;
      font-size: 0.9rem;
      border: var(--geometric-border);
      white-space: pre-wrap;
      overflow-x: auto;
      max-height: 300px;
    }

    #notesPreview {
      background-color: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      margin-top: 1rem;
      border: var(--geometric-border);
    }

    .hash-display {
      font-size: 0.8rem;
      margin-top: 1rem;
      color: var(--text-secondary);
    }

    .geometric-pattern {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-image: 
        linear-gradient(45deg, var(--quantum-blue) 1px, transparent 1px),
        linear-gradient(-45deg, var(--quantum-blue) 1px, transparent 1px);
      background-size: 60px 60px;
      opacity: 0.04;
    }
  </style>
</head>
<body>
  <div class="geometric-pattern"></div>

  <header>
    <h1>LYGO Œî9 StarNexus</h1>
    <p style="color: var(--text-secondary); font-family: var(--font-glyph);">V7 Fusion Engine | Canonical Seal System</p>
  </header>

  <section class="controls">
    <input type="file" id="fileInput" />
    <button onclick="exportArchive()">‚¨á Export</button>
    <button onclick="clearLocal()">üóë Clear Local</button>
    <select id="toneFilter" multiple></select>
    <select id="tagFilter" multiple></select>
    <input type="text" id="searchBox" placeholder="Search seal ID/title/tag..." />
    <button onclick="filterSeals()">üîç Filter</button>
  </section>

  <div id="starmap"></div>

  <section id="sealDetails">
    <h2 id="detailTitle">Seal Details</h2>
    <pre class="seal-preview-json" id="jsonPreview">{}</pre>
    <div class="hash-display" id="hashDisplay">SHA-256: N/A</div>
    <div id="notesPreview"></div>
  </section>

  <script>
    // Script content comes in Part 2 and Part 3
  </script>
</body>
</html>
<script>
let archive = []; // loaded seals
let activeSeal = null;

const $ = sel => document.querySelector(sel);

// ------------------------------
// Load from file
// ------------------------------
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    const text = event.target.result;
    try {
      const json = JSON.parse(text);
      if (Array.isArray(json)) {
        archive = json;
      } else if (json.seals) {
        archive = json.seals;
      } else {
        archive = [json];
      }
      saveToLocal();
      renderMap();
      populateFilters();
    } catch (err) {
      alert("Invalid JSON: " + err.message);
    }
  };
  reader.readAsText(file);
});

// ------------------------------
// LocalStorage Auto Save
// ------------------------------
function saveToLocal() {
  localStorage.setItem('SEAL_ARCHIVE_LYRA', JSON.stringify(archive));
}

function loadFromLocal() {
  const data = localStorage.getItem('SEAL_ARCHIVE_LYRA');
  if (data) {
    if (confirm("Restore previous session?")) {
      try {
        archive = JSON.parse(data);
        renderMap();
        populateFilters();
      } catch (e) {
        console.warn("Failed to load local archive");
      }
    }
  }
}

function clearLocal() {
  localStorage.removeItem('SEAL_ARCHIVE_LYRA');
  alert("Local archive cleared.");
}

// ------------------------------
// Render starmap (simple layout)
// ------------------------------
function renderMap() {
  const svg = d3.select("#starmap").html("").append("svg")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("viewBox", "0 0 1000 600");

  const pad = 80;
  const max = archive.length;
  archive.forEach((seal, i) => {
    const angle = i * (2 * Math.PI / max);
    const radius = 220 + (i % 7) * 15;
    const cx = 500 + Math.cos(angle) * radius;
    const cy = 300 + Math.sin(angle) * radius;

    svg.append("circle")
      .attr("cx", cx)
      .attr("cy", cy)
      .attr("r", 8)
      .attr("fill", "#00f0ff")
      .attr("stroke", "#7d00ff")
      .attr("stroke-width", 2)
      .on("mouseover", () => showTooltip(seal, cx, cy))
      .on("mouseout", hideTooltip)
      .on("click", () => setActiveSeal(seal));
  });
}

// ------------------------------
// Tooltip (hover preview)
// ------------------------------
let tooltip;
function showTooltip(seal, x, y) {
  tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("left", x + "px")
    .style("top", y + "px")
    .style("padding", "6px 10px")
    .style("background", "#111")
    .style("color", "#fff")
    .style("font", "12px Space Mono")
    .style("pointer-events", "none")
    .style("border", "1px solid #00f0ff")
    .style("border-radius", "4px")
    .html(`<strong>${seal.id}</strong><br/>${seal.title}`);
}

function hideTooltip() {
  if (tooltip) tooltip.remove();
}

// ------------------------------
// Seal Detail Panel
// ------------------------------
function setActiveSeal(seal) {
  activeSeal = seal;
  $("#detailTitle").textContent = `${seal.id} ¬∑ ${seal.title}`;
  $("#jsonPreview").textContent = JSON.stringify(seal, null, 2);

  const sha = CryptoJS.SHA256(JSON.stringify(seal)).toString();
  $("#hashDisplay").textContent = "SHA-256: " + sha;

  const md = seal.notes || "";
  $("#notesPreview").innerHTML = marked.parse(md);
}

// ------------------------------
// Filters
// ------------------------------
function populateFilters() {
  const tones = new Set();
  const tags = new Set();
  archive.forEach(seal => {
    if (Array.isArray(seal.tags)) seal.tags.forEach(t => tags.add(t));
    if (seal.tone) tones.add(seal.tone);
  });

  const toneFilter = $("#toneFilter");
  const tagFilter = $("#tagFilter");
  toneFilter.innerHTML = "";
  tagFilter.innerHTML = "";

  [...tones].sort().forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    toneFilter.appendChild(opt);
  });

  [...tags].sort().forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    tagFilter.appendChild(opt);
  });
}

function filterSeals() {
  const toneSel = [...$("#toneFilter").selectedOptions].map(o => o.value);
  const tagSel = [...$("#tagFilter").selectedOptions].map(o => o.value);
  const search = $("#searchBox").value.toLowerCase();

  const filtered = archive.filter(seal => {
    const matchesTone = toneSel.length === 0 || toneSel.includes(seal.tone);
    const matchesTag = tagSel.length === 0 || (seal.tags || []).some(t => tagSel.includes(t));
    const matchesSearch = [seal.id, seal.title, ...(seal.tags || [])].some(val =>
      String(val || "").toLowerCase().includes(search)
    );
    return matchesTone && matchesTag && matchesSearch;
  });

  renderFilteredMap(filtered);
}

function renderFilteredMap(filtered) {
  const svg = d3.select("#starmap").html("").append("svg")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("viewBox", "0 0 1000 600");

  const max = filtered.length;
  filtered.forEach((seal, i) => {
    const angle = i * (2 * Math.PI / max);
    const radius = 200 + (i % 6) * 22;
    const cx = 500 + Math.cos(angle) * radius;
    const cy = 300 + Math.sin(angle) * radius;

    svg.append("circle")
      .attr("cx", cx)
      .attr("cy", cy)
      .attr("r", 9)
      .attr("fill", "#00ffaa")
      .attr("stroke", "#5555ff")
      .attr("stroke-width", 2)
      .on("mouseover", () => showTooltip(seal, cx, cy))
      .on("mouseout", hideTooltip)
      .on("click", () => setActiveSeal(seal));
  });
}

// ------------------------------
// Export
// ------------------------------
function exportArchive() {
  const blob = new Blob([JSON.stringify(archive, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "LYRA_SEALS_ARCHIVE.json";
  a.click();
}

loadFromLocal();
</script>
