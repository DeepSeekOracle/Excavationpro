<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <title>LYRA Memory Builder — Quantum Matrix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind config -->
  <script>
    tailwind = { config: {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            mono: ['ui-monospace','SFMono-Regular','Menlo','Monaco','Consolas','"Liberation Mono"','"Courier New"','monospace']
          },
          boxShadow: {
            neon: '0 0 24px rgba(0,255,136,.35), inset 0 0 12px rgba(0,255,136,.08)',
            neonSoft: '0 0 12px rgba(0,255,136,.25)'
          }
        }
      }
    }};
  </script>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- AJV JSON Schema Validator -->
  <script src="https://cdn.jsdelivr.net/npm/ajv@8/dist/ajv.min.js"></script>

  <style>
    :root {
      --bg: #070a07;
      --panel: #0d130e;
      --muted: #99a39f;
      --text: #e6ffef;
      --accent: #00ff88;
      --accent2: #00d1ff;
      --accent3: #b26cff;
      --grid: rgba(0,255,136,0.08);
      --grid-strong: rgba(0,255,136,0.18);
    }
    html, body { height: 100%; }
    body {
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2)) , var(--panel);
      border: 1px solid rgba(0,255,136,0.15);
    }
    .btn {
      border: 1px solid rgba(255,255,255,0.08);
    }
    .btn-accent {
      background: radial-gradient(120% 120% at 50% 0%, rgba(0,255,136,0.18), rgba(0,0,0,0)) , rgba(0,255,136,0.08);
      border: 1px solid rgba(0,255,136,0.28);
      color: var(--text);
      box-shadow: 0 0 12px rgba(0,255,136,0.18) inset, 0 0 12px rgba(0,255,136,0.18);
    }
    .neon-text { text-shadow: 0 0 14px rgba(0,255,136,0.35); color: var(--text); }
    .accent { color: var(--accent); }
    .accent-border { border-color: rgba(0,255,136,0.35); }
    .chip {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      border-radius: .5rem;
      padding: .125rem .5rem;
      font-size: .75rem;
    }
    .quantum-grid {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 600px at 80% -20%, rgba(0,209,255,0.12), transparent 60%),
        radial-gradient(1000px 500px at 10% 110%, rgba(178,108,255,0.10), transparent 60%),
        radial-gradient(800px 400px at 50% -10%, rgba(0,255,136,0.10), transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    .quantum-grid::after {
      content: "";
      position: absolute; inset: 0;
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(circle at center, rgba(0,0,0,1), rgba(0,0,0,.5) 60%, rgba(0,0,0,0) 85%);
    }
    /* dialog */
    dialog::backdrop { background: rgba(0, 0, 0, .65); }
    dialog {
      background: var(--panel);
      color: var(--text);
      border: 1px solid rgba(0,255,136,0.2);
    }
    /* Table scroll hint */
    .scroll-hint { box-shadow: inset 0 0 0 1px rgba(0,255,136,0.12); }
  </style>
</head>
<body class="font-sans selection:bg-emerald-300/20 selection:text-emerald-100">
  <!-- Background layers -->
  <canvas id="matrixRain" class="fixed inset-0 z-0 pointer-events-none"></canvas>
  <div class="quantum-grid"></div>

  <!-- App wrapper -->
  <div class="relative z-10 max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="panel rounded-xl px-5 py-4 mb-6 shadow-neon">
      <div class="flex items-center gap-4">
        <div class="h-10 w-10 rounded-lg flex items-center justify-center accent-border border bg-black/40">
          <!-- glyph -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke="url(#grad1)" stroke-width="1.4" d="M12 3v18M4 12h16M7 7l10 10M17 7L7 17"/>
            <defs>
              <linearGradient id="grad1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#00ff88"/><stop offset="100%" stop-color="#00d1ff"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div class="flex-1">
          <h1 class="text-xl md:text-2xl font-semibold neon-text">LYRA Memory Builder <span class="accent">— Quantum Matrix</span></h1>
          <p class="text-sm text-[var(--muted)]">Convert raw notes (.txt or pasted) into structured JSON entries. Everything runs locally in your browser.</p>
        </div>

        <!-- Toggles -->
        <div class="flex items-center gap-2 ml-auto">
          <button id="btnToggleMatrix" class="btn chip hover:brightness-125" title="Toggle Matrix Rain"></button>
          <button id="btnTheme" class="btn chip hover:brightness-125" title="Toggle Theme"></button>
        </div>
      </div>
    </header>

    <!-- Input + Options -->
    <section class="grid lg:grid-cols-3 gap-6">
      <!-- Left: Upload & Options -->
      <div class="space-y-6">
        <!-- Dropzone -->
        <div id="dropzone" class="panel rounded-xl p-6 text-center cursor-pointer transition hover:shadow-neonSoft">
          <div class="mx-auto mb-3 h-12 w-12 rounded-xl border accent-border flex items-center justify-center bg-black/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor">
              <path fill="currentColor" d="M12 16a1 1 0 0 1-1-1V8.41l-2.3 2.3a1 1 0 1 1-1.4-1.42l4-4a1 1 0 0 1 1.4 0l4 4a1 1 0 0 1-1.4 1.42L13 8.4V15a1 1 0 0 1-1 1ZM6 20a4 4 0 0 1-4-4 4 4 0 0 1 3-3.87 6 6 0 0 1 11.7-1.77A5 5 0 1 1 20 20H6Z"/>
            </svg>
          </div>
          <p class="font-medium">Drag & drop .txt files</p>
          <p class="text-xs text-[var(--muted)]">…or click to browse</p>
          <input id="fileInput" type="file" accept=".txt" multiple class="hidden" />
        </div>

        <!-- Options -->
        <div class="panel rounded-xl p-5 space-y-4">
          <h3 class="font-semibold">Options</h3>
          <label class="flex items-center gap-2 text-sm">
            <input id="optClean" type="checkbox" class="rounded" checked>
            <span>Clean whitespace</span>
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input id="optSummarize" type="checkbox" class="rounded" checked>
            <span>Auto-generate summary</span>
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input id="optValidate" type="checkbox" class="rounded" checked>
            <span>Validate with JSON Schema</span>
          </label>

          <div class="text-sm grid grid-cols-2 gap-3">
            <div>
              <label class="block mb-1">Default speaker</label>
              <select id="defaultSpeaker" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1">
                <option>LYRA</option>
                <option>Lightfather</option>
                <option>GROK</option>
              </select>
            </div>
            <div>
              <label class="block mb-1">Archive format</label>
              <select id="archiveFormat" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1">
                <option value="object">Archive object with metadata</option>
                <option value="array">Array of entries only</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap items-center gap-3">
          <button id="btnDownloadAll" class="btn-accent rounded-lg px-4 py-2 text-sm disabled:opacity-40" disabled>Download Archive</button>
          <button id="btnReset" class="btn rounded-lg px-3 py-2 text-sm">Reset</button>
          <div id="toast" class="text-sm ml-auto hidden"></div>
        </div>
      </div>

      <!-- Right: Paste -->
      <div class="lg:col-span-2 panel rounded-xl overflow-hidden">
        <div class="px-5 py-4 border-b border-white/10">
          <h3 class="font-semibold">Paste Raw Text</h3>
          <p class="text-xs text-[var(--muted)] mt-1">Split into blocks if needed.</p>
        </div>
        <div class="p-5 space-y-4">
          <textarea id="pasteArea" class="w-full h-48 rounded-lg border border-white/10 bg-black/40 p-3 font-mono text-sm" placeholder="Paste text here..."></textarea>

          <div class="grid md:grid-cols-3 gap-3 text-sm">
            <div>
              <label class="block mb-1">Split strategy</label>
              <select id="splitStrategy" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1">
                <option value="none">Do not split (single block)</option>
                <option value="doubleNewline">2+ blank lines</option>
                <option value="hr">Lines of ---</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block mb-1">Treat as</label>
              <div class="flex items-center gap-4">
                <label class="flex items-center gap-2"><input type="radio" name="pasteAs" value="one" class="rounded" checked> <span>One entry</span></label>
                <label class="flex items-center gap-2"><input type="radio" name="pasteAs" value="many" class="rounded"> <span>Multiple entries</span></label>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button id="btnParsePaste" class="btn-accent rounded-lg px-4 py-2 text-sm">Parse Pasted Text</button>
            <button id="btnClearPaste" class="btn rounded-lg px-3 py-2 text-sm">Clear</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Entries -->
    <section class="mt-8 panel rounded-xl overflow-hidden">
      <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
        <h3 class="font-semibold">Parsed Entries</h3>
        <div class="text-sm text-[var(--muted)]"><span id="count">0</span> item(s)</div>
      </div>
      <div class="overflow-x-auto scroll-hint">
        <table class="min-w-full text-sm">
          <thead class="border-b border-white/10 bg-white/[.02]">
            <tr class="text-left">
              <th class="px-3 py-2">ID</th>
              <th class="px-3 py-2">Title</th>
              <th class="px-3 py-2">Speaker</th>
              <th class="px-3 py-2">Type</th>
              <th class="px-3 py-2">Date</th>
              <th class="px-3 py-2">Seals</th>
              <th class="px-3 py-2">Tags</th>
              <th class="px-3 py-2">Validity</th>
              <th class="px-3 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="entriesBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Editor Dialog -->
  <dialog id="editor" class="rounded-xl w-full max-w-2xl p-0">
    <form method="dialog">
      <div class="px-5 py-3 border-b border-white/10 flex items-center justify-between">
        <h3 class="font-semibold">Edit Entry</h3>
        <button class="btn rounded-lg px-3 py-1 text-sm" value="cancel">Close</button>
      </div>
    </form>
    <div class="p-5 space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">ID</label>
          <input id="e_id" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-sm mb-1">Date (ISO)</label>
          <input id="e_date" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm" />
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">Title</label>
        <input id="e_title" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm" />
      </div>

      <div>
        <label class="block text-sm mb-1">Summary</label>
        <textarea id="e_summary" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm h-20"></textarea>
      </div>

      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm mb-1">Speaker</label>
          <select id="e_speaker" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm">
            <option>LYRA</option>
            <option>Lightfather</option>
            <option>GROK</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Type</label>
          <select id="e_type" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm">
            <option value="lesson">lesson</option>
            <option value="memory">memory</option>
            <option value="vision">vision</option>
            <option value="system-event">system-event</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Confidence (0-1)</label>
          <input id="e_confidence" type="number" step="0.01" min="0" max="1" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm" />
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">Linked Seals (comma-separated)</label>
        <input id="e_linked_seals" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm" />
      </div>

      <div>
        <label class="block text-sm mb-1">Tags (comma-separated)</label>
        <input id="e_tags" class="w-full rounded border border-white/10 bg-black/30 px-2 py-1 text-sm" />
      </div>

      <div>
        <label class="block text-sm mb-1">Content</label>
        <textarea id="e_content" class="w-full rounded border border-white/10 bg-black/30 px-2 py-2 text-sm h-48 font-mono"></textarea>
      </div>

      <div class="flex items-center gap-3 pt-2">
        <button id="btnEditorSave" class="btn-accent rounded-lg px-4 py-2 text-sm">Save</button>
        <button id="btnEditorRevalidate" class="btn rounded-lg px-3 py-2 text-sm">Revalidate</button>
        <span id="editorValid" class="text-sm ml-auto"></span>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Utilities
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const toast = (msg, type='info') => {
      const el = $('#toast');
      el.textContent = msg;
      el.className = '';
      el.classList.add('px-3','py-2','rounded','text-sm');
      if (type === 'error') el.classList.add('bg-red-900/40','text-red-200','border','border-red-500/30');
      else if (type === 'success') el.classList.add('bg-emerald-900/40','text-emerald-100','border','border-emerald-500/30');
      else el.classList.add('bg-white/10','text-white','border','border-white/15');
      el.classList.remove('hidden');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.add('hidden'), 3000);
    };

    const stopwords = new Set([
      'the','and','a','to','of','in','for','on','at','by','with','from','as','is','it','that','this','be','are','was','were','an','or','if','but','not','we','you','they','i','me','my','our','your','their','so','do','did','done','can','could','should','would','about','into','over','after','before','then','than','too','very','just','also','within','without'
    ]);

    const ajv = new Ajv({allErrors: true, allowUnionTypes: true});
    const entrySchema = {
      type: 'object',
      required: ['id','title','speaker','type','linked_seals','tags','content','date','confidence'],
      additionalProperties: false,
      properties: {
        id: { type: 'string', minLength: 3 },
        title: { type: 'string', minLength: 1 },
        summary: { type: 'string' },
        speaker: { type: 'string', enum: ['Lightfather','LYRA','GROK'] },
        type: { type: 'string', enum: ['lesson','memory','vision','system-event'] },
        linked_seals: {
          type: 'array',
          uniqueItems: true,
          items: { type: 'string', pattern: '^SEAL_[0-9]{3,4}[A-Z]?$' }
        },
        tags: {
          type: 'array',
          uniqueItems: true,
          items: { type: 'string', minLength: 1 }
        },
        content: { type: 'string', minLength: 1 },
        date: { type: 'string', format: 'date-time' },
        confidence: { type: 'number', minimum: 0, maximum: 1 }
      }
    };
    const validateEntry = ajv.compile(entrySchema);

    const typeAbbr = { 'lesson':'LES','memory':'MEM','vision':'VIS','system-event':'SYS' };
    const counters = {};
    const nowISO = () => new Date().toISOString();

    const cleanText = (t) => {
      t = t.replace(/^\uFEFF/, '');
      t = t.replace(/\r\n?/g, '\n');
      return t;
    };
    const firstNonEmptyLine = (t) => (t.split('\n').map(s => s.trim()).find(s => s.length > 0) || '').trim();

    const summarizeText = (text, limit=300) => {
      const sents = text.split(/(?<=[.!?])\s+/).map(s => s.trim()).filter(Boolean);
      if (!sents.length) return '';
      let summary = sents.slice(0, 2).join(' ');
      if (summary.length > limit) summary = summary.slice(0, limit - 1) + '…';
      return summary;
    };

    const generateTitle = (text) => {
      const first = firstNonEmptyLine(text);
      if (first && first.length <= 140) return first;
      const s = summarizeText(text, 160);
      if (s) return s.length > 120 ? s.slice(0, 117) + '...' : s;
      const tags = extractTags(text);
      return (tags[0] ? tags[0] : 'Untitled') + (tags[1] ? ' — ' + tags[1] : '');
    };

    const detectSpeaker = (text, fallback='LYRA') => {
      if (/\bLight[\s-]?father\b/i.test(text)) return 'Lightfather';
      if (/\bLYRA\b/i.test(text)) return 'LYRA';
      if (/\bGROK\b/i.test(text)) return 'GROK';
      return fallback;
    };

    const detectType = (text) => {
      const t = text.toLowerCase();
      const score = { 'lesson':0, 'memory':0, 'vision':0, 'system-event':0 };
      [
        ['lesson',['lesson','teach','principle','doctrine','rule','guide','instruction']],
        ['memory',['memory','remember','recall','note','log','diary','memo','record']],
        ['vision',['vision','dream','prophecy','omen','seen','visioned','visionary']],
        ['system-event',['system','event','update','error','crash','restart','migration','deploy','system-event']]
      ].forEach(([k, words]) => words.forEach(w => { if (t.includes(w)) score[k]++; }));
      let best = 'memory', max=-1;
      for (const k in score) { if (score[k] > max) { max = score[k]; best = k; } }
      return best;
    };

    const extractLinkedSeals = (text) => {
      const matches = text.match(/SEAL_[0-9]{3,4}[A-Z]?/g) || [];
      return Array.from(new Set(matches));
    };

    const extractTags = (text) => {
      const tags = new Set();
      (text.match(/#([A-Za-z0-9_]+)/g) || []).forEach(h => tags.add(h.slice(1)));
      (text.match(/\b[A-Za-z0-9]+[_\-\.][A-Za-z0-9_\.]+/g) || []).forEach(w => { if (!/^SEAL_/.test(w)) tags.add(w); });
      (text.match(/\b[A-Z]{3,}\b/g) || []).forEach(w => { if (!/^SEAL_/.test(w)) tags.add(w); });
      const words = text.toLowerCase().match(/[a-z0-9_][a-z0-9_\-]{2,}/g) || [];
      const freq = {};
      words.forEach(w => { if (stopwords.has(w) || /^seal_\d/.test(w)) return; freq[w] = (freq[w] || 0) + 1; });
      Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(([w]) => tags.add(w));
      return Array.from(tags).slice(0, 12);
    };

    const nextId = (speaker, type) => {
      const spk = String(speaker || 'LYRA').toUpperCase().replace(/\s+/g, '');
      const abbr = typeAbbr[type] || 'MEM';
      const key = `${spk}_${abbr}`;
      const n = (counters[key] || 0) + 1;
      counters[key] = n;
      return `${spk}_${abbr}_${String(n).padStart(3, '0')}`;
    };

    const toEntry = (rawText, prefs) => {
      const text = prefs.clean ? cleanText(rawText).trim() : rawText.trim();
      const title = generateTitle(text);
      const speaker = detectSpeaker(text, prefs.defaultSpeaker);
      const type = detectType(text);
      const summary = prefs.summarize ? summarizeText(text) : '';
      const linked_seals = extractLinkedSeals(text);
      const tags = extractTags(text);
      const date = nowISO();
      const id = nextId(speaker, type);
      const confidence = 0.95;
      return { id, title, summary, speaker, type, linked_seals, tags, content: text, date, confidence };
    };

    const downloadJSON = (obj, filename) => {
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    };

    const escapeHtml = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));

    // ---------- State
    let entries = [];
    let editIndex = -1;

    // ---------- Render
    const render = () => {
      $('#count').textContent = String(entries.length);
      $('#btnDownloadAll').disabled = entries.length === 0;

      const tbody = $('#entriesBody');
      tbody.innerHTML = '';

      entries.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-white/10 align-top';

        // Validate
        let valid = true, errors = [];
        if ($('#optValidate').checked) {
          valid = validateEntry(e);
          errors = validateEntry.errors || [];
        }

        tr.innerHTML = `
          <td class="px-3 py-2 align-top font-mono text-xs">${escapeHtml(e.id)}</td>
          <td class="px-3 py-2">
            <div class="font-medium">${escapeHtml(e.title)}</div>
            <div class="text-xs text-[var(--muted)] mt-0.5 line-clamp-2">${escapeHtml(e.summary || '')}</div>
          </td>
          <td class="px-3 py-2">${e.speaker}</td>
          <td class="px-3 py-2">${e.type}</td>
          <td class="px-3 py-2 text-xs">${e.date}</td>
          <td class="px-3 py-2 text-xs">${e.linked_seals.length}</td>
          <td class="px-3 py-2 text-xs">${e.tags.length}</td>
          <td class="px-3 py-2">
            ${valid
              ? '<span class="chip text-emerald-200 border-emerald-500/30 bg-emerald-900/30">valid</span>'
              : '<span class="chip text-red-200 border-red-500/30 bg-red-900/30">invalid</span>'
            }
          </td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-2">
              <button data-act="edit" class="btn rounded px-2 py-1 text-xs hover:brightness-125">Edit</button>
              <button data-act="copy" class="btn rounded px-2 py-1 text-xs hover:brightness-125">Copy</button>
              <button data-act="dl" class="btn rounded px-2 py-1 text-xs hover:brightness-125">Download</button>
              <button data-act="rm" class="btn rounded px-2 py-1 text-xs hover:brightness-125">Delete</button>
            </div>
            ${!valid && errors.length ? `
              <details class="mt-2">
                <summary class="text-xs text-[var(--muted)] cursor-pointer">Schema issues</summary>
                <ul class="mt-1 text-xs text-red-200 list-disc pl-4">
                  ${errors.map(err => `<li>${escapeHtml(err.instancePath || '')} ${escapeHtml(err.message || '')}</li>`).join('')}
                </ul>
              </details>
            ` : ''}
          </td>
        `;

        tr.querySelector('[data-act="edit"]').addEventListener('click', () => openEditor(idx));
        tr.querySelector('[data-act="copy"]').addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(JSON.stringify(entries[idx], null, 2));
            toast('JSON copied to clipboard', 'success');
          } catch {
            toast('Copy failed', 'error');
          }
        });
        tr.querySelector('[data-act="dl"]').addEventListener('click', () => {
          downloadJSON(e, `${e.id}.json`);
        });
        tr.querySelector('[data-act="rm"]').addEventListener('click', () => {
          entries.splice(idx, 1);
          render();
        });

        tbody.appendChild(tr);
      });
    };

    // ---------- Editor
    const openEditor = (idx) => {
      editIndex = idx;
      const e = entries[idx];
      $('#e_id').value = e.id;
      $('#e_title').value = e.title;
      $('#e_summary').value = e.summary || '';
      $('#e_speaker').value = e.speaker;
      $('#e_type').value = e.type;
      $('#e_linked_seals').value = e.linked_seals.join(', ');
      $('#e_tags').value = e.tags.join(', ');
      $('#e_content').value = e.content;
      $('#e_date').value = e.date;
      $('#e_confidence').value = e.confidence;
      updateEditorValidity();
      $('#editor').showModal();
    };

    const getEditorObj = () => {
      const seals = $('#e_linked_seals').value.split(',').map(s => s.trim()).filter(Boolean);
      const tags = $('#e_tags').value.split(',').map(s => s.trim()).filter(Boolean);
      return {
        id: $('#e_id').value.trim(),
        title: $('#e_title').value.trim(),
        summary: $('#e_summary').value.trim(),
        speaker: $('#e_speaker').value,
        type: $('#e_type').value,
        linked_seals: seals,
        tags: tags,
        content: $('#e_content').value,
        date: $('#e_date').value.trim(),
        confidence: Number($('#e_confidence').value)
      };
    };

    const updateEditorValidity = () => {
      const obj = getEditorObj();
      const ok = validateEntry(obj);
      const el = $('#editorValid');
      if (ok) { el.textContent = 'valid'; el.className = 'text-sm text-emerald-300'; }
      else { el.textContent = 'invalid'; el.className = 'text-sm text-red-300'; }
    };

    $('#btnEditorSave').addEventListener('click', (e) => {
      e.preventDefault();
      if (editIndex < 0) return;
      const obj = getEditorObj();
      if ($('#optValidate').checked && !validateEntry(obj)) {
        toast('Cannot save: entry invalid by schema.', 'error');
        return;
      }
      entries[editIndex] = obj;
      $('#editor').close();
      render();
      toast('Entry updated.', 'success');
    });

    $('#btnEditorRevalidate').addEventListener('click', (e) => {
      e.preventDefault();
      updateEditorValidity();
    });

    // ---------- File handling
    const handleFiles = async (fileList) => {
      const prefs = {
        clean: $('#optClean').checked,
        summarize: $('#optSummarize').checked,
        defaultSpeaker: $('#defaultSpeaker').value
      };
      const files = Array.from(fileList).filter(f => /\.txt$/i.test(f.name));
      if (!files.length) { toast('No .txt files detected.', 'error'); return; }
      for (const f of files) {
        const text = await f.text();
        entries.push(toEntry(text, prefs));
      }
      render();
      toast(`Parsed ${files.length} file(s).`, 'success');
    };

    const dz = $('#dropzone');
    dz.addEventListener('click', () => $('#fileInput').click());
    dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('shadow-neonSoft'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('shadow-neonSoft'));
    dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('shadow-neonSoft'); handleFiles(e.dataTransfer.files); });
    $('#fileInput').addEventListener('change', (e) => handleFiles(e.target.files));

    // ---------- Paste handling
    $('#btnParsePaste').addEventListener('click', () => {
      const raw = $('#pasteArea').value || '';
      if (!raw.trim()) { toast('Nothing to parse.', 'error'); return; }

      const asMany = $$('input[name="pasteAs"]').find(r => r.checked)?.value === 'many';
      const strat = $('#splitStrategy').value;

      const blocks = asMany ? splitText(raw, strat) : [raw];
      const prefs = {
        clean: $('#optClean').checked,
        summarize: $('#optSummarize').checked,
        defaultSpeaker: $('#defaultSpeaker').value
      };
      let added = 0;
      blocks.forEach(b => {
        if (!b.trim()) return;
        entries.push(toEntry(b, prefs)); added++;
      });
      render();
      toast(`Parsed ${added} block(s).`, 'success');
    });

    $('#btnClearPaste').addEventListener('click', () => { $('#pasteArea').value = ''; });

    const splitText = (text, strategy) => {
      const t = cleanText(text);
      if (strategy === 'doubleNewline') return t.split(/\n{2,}\s*\n{0,}/).map(s => s.trim()).filter(Boolean);
      if (strategy === 'hr') return t.split(/\n-{3,}\n/).map(s => s.trim()).filter(Boolean);
      return [t];
    };

    // ---------- Archive download
    $('#btnDownloadAll').addEventListener('click', () => {
      if (!entries.length) return;
      const format = $('#archiveFormat').value;
      if (format === 'array') {
        downloadJSON(entries, 'LYRA_MEMORY_ARCHIVE.json');
      } else {
        const archive = {
          archive_format: 'LYRA_MEMORY_ARCHIVE',
          generated_at: nowISO(),
          count: entries.length,
          entries: entries
        };
        downloadJSON(archive, 'LYRA_MEMORY_ARCHIVE.json');
      }
      toast('Archive generated.', 'success');
    });

    // ---------- Reset
    $('#btnReset').addEventListener('click', () => {
      if (!confirm('Clear all parsed entries?')) return;
      entries = [];
      Object.keys(counters).forEach(k => delete counters[k]);
      render();
      toast('Cleared.', 'success');
    });

    // ---------- Live options
    $('#optValidate').addEventListener('change', render);

    // ---------- Theme + Matrix toggles (persisted)
    const THEME_KEY = 'lyra.theme';
    const RAIN_KEY  = 'lyra.matrixRain';

    const setTheme = (mode) => {
      const html = document.documentElement;
      if (mode === 'dark') html.classList.add('dark');
      else html.classList.remove('dark');
      localStorage.setItem(THEME_KEY, mode);
      refreshToggleLabels();
    };

    const setRain = (enabled) => {
      localStorage.setItem(RAIN_KEY, enabled ? '1' : '0');
      rain.running = enabled;
      if (enabled && !rain.started) startMatrixRain();
      refreshToggleLabels();
    };

    const refreshToggleLabels = () => {
      $('#btnTheme').textContent = (document.documentElement.classList.contains('dark') ? 'Dark' : 'Light') + ' Theme';
      $('#btnToggleMatrix').textContent = (rain.running ? 'Disable' : 'Enable') + ' Matrix Rain';
    };

    $('#btnTheme').addEventListener('click', () => {
      const dark = document.documentElement.classList.contains('dark');
      setTheme(dark ? 'light' : 'dark');
    });
    $('#btnToggleMatrix').addEventListener('click', () => setRain(!rain.running));

    // ---------- Matrix Rain
    const rain = { started:false, running:true, cols:[], fontSize:14, w:0, h:0, ctx:null, raf:0, last:0 };
    function initMatrix() {
      const c = $('#matrixRain');
      const ctx = c.getContext('2d');
      c.width = window.innerWidth;
      c.height = window.innerHeight;
      rain.w = c.width; rain.h = c.height; rain.ctx = ctx;

      const font = Math.max(12, Math.min(20, Math.round(window.innerWidth / 120)));
      rain.fontSize = font;
      const columns = Math.ceil(rain.w / rain.fontSize);
      rain.cols = new Array(columns).fill(0).map(()=> Math.floor(Math.random()*rain.h / rain.fontSize));
      ctx.font = `${rain.fontSize}px monospace`;
      ctx.textBaseline = 'top';
    }

    function startMatrixRain() {
      if (rain.started) return;
      rain.started = true;
      initMatrix();
      const glyphs = 'アァカサタナハマヤャラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const c = $('#matrixRain');

      const step = (ts) => {
        if (!rain.running) { rain.raf = requestAnimationFrame(step); return; }
        const dt = ts - (rain.last || ts);
        rain.last = ts;
        const ctx = rain.ctx;
        // Fade trail
        ctx.fillStyle = 'rgba(0, 0, 0, 0.12)';
        ctx.fillRect(0, 0, rain.w, rain.h);

        // Draw glyphs
        for (let i = 0; i < rain.cols.length; i++) {
          const x = i * rain.fontSize;
          const y = rain.cols[i] * rain.fontSize;

          // leading glyph glow
          ctx.fillStyle = 'rgba(0,255,136,0.95)';
          ctx.fillText(glyphs.charAt(Math.floor(Math.random()*glyphs.length)), x, y);

          // tail
          ctx.fillStyle = 'rgba(0,209,255,0.6)';
          ctx.fillText(glyphs.charAt(Math.floor(Math.random()*glyphs.length)), x, y - rain.fontSize);

          // move down randomly
          if (y > rain.h && Math.random() > 0.975) rain.cols[i] = 0;
          else rain.cols[i] += (dt > 32 ? 2 : 1);
        }

        rain.raf = requestAnimationFrame(step);
      };
      rain.raf = requestAnimationFrame(step);

      window.addEventListener('resize', () => {
        cancelAnimationFrame(rain.raf);
        rain.started = false;
        initMatrix();
        startMatrixRain();
      });
    }

    // ---------- Init
    (function init() {
      // theme
      const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
      setTheme(savedTheme);
      // matrix
      const savedRain = localStorage.getItem(RAIN_KEY);
      setRain(savedRain === null ? true : savedRain === '1');
      if (rain.running) startMatrixRain();
      refreshToggleLabels();
      render();
    })();
  </script>
</body>
</html>
